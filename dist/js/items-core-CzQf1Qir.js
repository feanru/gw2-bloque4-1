import{getCached as e,setCached as t}from"./utils/cache.min.js";import{fetchWithCache as i}from"./utils/requestCache.min.js";function n(e=[],{interval:t=6e4,concurrency:i=5,maxRetries:n=3,onUpdate:r=()=>{}}={}){let o=Array.from(new Set(e)),a=null;async function l(e,t,i=500){try{return await v(e)}catch(n){if(t<=0)throw n;return await new Promise(e=>setTimeout(e,i)),l(e,t-1,2*i)}}async function s(e){for(;e.length;){const t=e.shift();try{const e=await l(t,n);r(t,e)}catch(e){console.error("Price update failed for",t,e)}}}function d(){const e=o.slice(),t=Math.min(i,e.length);for(let i=0;i<t;i++)s(e)}return a=setInterval(d,t),d(),{updateIds(e=[]){o=Array.from(new Set(e))},stop(){a&&clearInterval(a)}}}function r(e){window.ingredientObjs=e}"undefined"!=typeof window&&(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window._mainBuyPrice=window._mainBuyPrice||0,window._mainSellPrice=window._mainSellPrice||0,window._mainRecipeOutputCount=window._mainRecipeOutputCount||1);class o{constructor({id:e,name:t,icon:i,rarity:n,count:r,parentMultiplier:a=1,buy_price:l,sell_price:s,is_craftable:d,recipe:c,children:u=[],_parentId:w=null}){this._uid=o.nextUid++,this.id=e,this.name=t,this.icon=i,this.rarity=n,this.count=r,this.parentMultiplier=a||1,this.buy_price=l,this.sell_price=s,this.is_craftable=d,this.recipe=c||null,this.children=u,this.mode="buy",this.modeForParentCrafted="buy",this.expanded=!1,this._parentId=w,this._parent=null,this.countTotal=0,this.crafted_price=null,this.total_buy=0,this.total_sell=0,this.total_crafted=0}findRoot(){let e=this;for(;e._parent;)e=e._parent;return e}setMode(e){if(["buy","sell","crafted"].includes(e)){this.modeForParentCrafted=e;this.findRoot().recalc(window.globalQty||1,null),"function"==typeof window.safeRenderTable&&window.safeRenderTable()}}recalc(e=1,t=null){const i=null==t;this.countTotal=i?this.count*e:t.countTotal*this.count,this.children&&this.children.length>0&&this.children.forEach(t=>t.recalc(e,this)),i?(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0)):(this.total_buy=(this.buy_price||0)*this.countTotal,this.total_sell=(this.sell_price||0)*this.countTotal),this.is_craftable&&this.children.length>0?(this.total_crafted=this.children.reduce((e,t)=>{switch(t.modeForParentCrafted){case"buy":default:return e+(t.total_buy||0);case"sell":return e+(t.total_sell||0);case"crafted":return e+(t.total_crafted||0)}},0),this.crafted_price=this.total_crafted/(this.recipe?.output_item_count||1),i||this.buy_price||this.sell_price||(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0))):(this.total_crafted=null,this.crafted_price=null)}getBestPrice(){return"number"==typeof this.buy_price&&this.buy_price>0?this.buy_price:"number"==typeof this.crafted_price&&this.crafted_price>0?this.crafted_price:0}}function a(e){window.globalQty=e}function l(e){return e?e.map(e=>({id:e.id,expanded:e.expanded,children:l(e.children||[])})):[]}function s(e,t){if(e&&t)for(let i=0;i<e.length;i++)t[i]&&(e[i].expanded=t[i].expanded,s(e[i].children,t[i].children))}function d(e,t){e&&e.forEach(e=>{e.recalc(t,null)})}function c(e){let t=0,i=0,n=0;for(const r of e)switch(t+=r.total_buy||0,i+=r.total_sell||0,r.modeForParentCrafted){case"sell":n+=r.total_sell||0;break;case"crafted":n+=r.total_crafted||0;break;default:n+=r.total_buy||0}return{totalBuy:t,totalSell:i,totalCrafted:n}}function u(e,t,i){for(const n of e){if(String(n.id)===String(t)&&String(n._parentId)===String(i))return n;if(Array.isArray(n.children)&&n.children.length){const e=u(n.children,t,i);if(e)return e}}return null}function w(e,t){let i=e,n=null;for(let e=0;e<t.length;e++){const r=t[e];if(n=(i||[]).find(e=>String(e._uid)===String(r)||String(e.id)===String(r)),!n)return null;i=n.children}return n}function f(e,t){for(const i of e){if(String(i._uid)===String(t))return i;if(i.children&&i.children.length){const e=f(i.children,t);if(e)return e}}return null}function p(e,t){for(const i of e){if(String(i.id)===String(t))return i;if(i.children&&i.children.length){const e=p(i.children,t);if(e)return e}}return null}o.nextUid=0;const h=new Set;function g(e){return h.add(e),e}function _(){h.forEach(e=>e.abort()),h.clear(),y&&(y.terminate(),y=null)}async function m(n){const r=g(new AbortController),o=`item_${n}`,a=e(o,!0),l={};a?.etag&&(l["If-None-Match"]=a.etag),a?.lastModified&&(l["If-Modified-Since"]=a.lastModified);try{const e=await i(`https://api.guildwars2.com/v2/items/${n}?lang=es`,{headers:l,signal:r.signal});if(304===e.status&&a)return a.value;if(!e.ok)throw new Error(`Error ${e.status} obteniendo datos del ítem ${n}`);const s=await e.json();s.lastUpdated=(new Date).toISOString();const d=e.headers.get("ETag"),c=e.headers.get("Last-Modified");return t(o,s,d||c?null:void 0,{etag:d,lastModified:c}),s}finally{h.delete(r)}}let y=null;async function b(e,t){return t&&t.ingredients&&0!==t.ingredients.length?(y&&y.terminate(),y=new Worker(new URL("./workers/ingredientTreeWorker.js",import.meta.url),{type:"module"}),new Promise((i,n)=>{const r=t=>{y.removeEventListener("message",r),y.removeEventListener("error",o);const n=t.data||[];y=null;const a=n.map(t=>I(t,t.parentMultiplier,e));function l(e,t){e._parent=t,e.children&&e.children.forEach(t=>l(t,e))}a.forEach(e=>{l(e,null),e.recalc(window.globalQty,null)}),i(a)},o=e=>{y.removeEventListener("message",r),y.removeEventListener("error",o),y=null,console.error("Error en ingredientTreeWorker:",e?.message||e,e);const t="Error procesando ingredientes"+(e?.message?`: ${e.message}`:"");window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(t,"error"):"function"==typeof alert&&alert(t),n(e)};y.addEventListener("message",r),y.addEventListener("error",o),y.postMessage({mainItemId:e,mainRecipeData:t})})):(window.ingredientObjs=[],window._mainRecipeOutputCount=t&&t.output_item_count||1,[])}async function S(n){const r=g(new AbortController),o=`recipe_${n}`,a=e(o);if(a)return h.delete(r),a;try{const e=await i(`https://api.guildwars2.com/v2/recipes/search?output=${n}`,{signal:r.signal});if(!e.ok)return null;const a=await e.json();if(!a||0===a.length)return null;const l=a[0],s=await i(`https://api.guildwars2.com/v2/recipes/${l}?lang=es`,{signal:r.signal});if(!s.ok)throw new Error(`Error ${s.status} obteniendo datos de la receta ${l}`);const d=await s.json();return d.lastUpdated=(new Date).toISOString(),t(o,d),d}finally{h.delete(r)}}async function v(n){const r=g(new AbortController),o=`price_${n}`,a=e(o,!0),l={};a?.etag&&(l["If-None-Match"]=a.etag),a?.lastModified&&(l["If-Modified-Since"]=a.lastModified);try{const e=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price","buy_quantity","sell_quantity","last_updated","1d_buy_sold","1d_sell_sold","2d_buy_sold","2d_sell_sold","7d_buy_sold","7d_sell_sold","1m_buy_sold","1m_sell_sold"].join(",")}&ids=${n}`,s=await i(e,{signal:r.signal,headers:l});if(304===s.status&&a){const e=s.headers.get("etag")||a.etag,i=s.headers.get("last-modified")||a.lastModified;return t(o,a.value,void 0,{etag:e,lastModified:i}),a.value}if(!s.ok)throw new Error(`Error ${s.status} obteniendo datos de mercado para el ítem ${n}`);const d=(await s.text()).trim().split("\n");if(d.length<2)return{};const c=d[0].split(","),u=d[1].split(","),w={};return c.forEach((e,t)=>{w[e]=void 0!==u[t]?isNaN(u[t])?u[t]:Number(u[t]):null}),t(o,w,void 0,{etag:s.headers.get("etag"),lastModified:s.headers.get("last-modified")}),w}finally{h.delete(r)}}function I(e,t=1,i=null){const n=new o({id:e.id,name:e.name,icon:e.icon,rarity:e.rarity,count:e.count||1,recipe:e.recipe||null,buy_price:e.buy_price||0,sell_price:e.sell_price||0,is_craftable:e.is_craftable||!1,children:[],_parentId:i});return e.children&&e.children.length>0&&(n.children=e.children.map(e=>I(structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e)),e.count*t,n.id))),n}if("undefined"!=typeof window){void 0===window.comparativa&&(window.comparativa={});let O=null;function j(){const e=window.ingredientObjs?window.ingredientObjs.map(e=>e.id):[];O?O.updateIds(e):O=n(e,{onUpdate:(e,t)=>{const i=p(window.ingredientObjs,e);i&&(i.buy_price=t.buy_price||0,i.sell_price=t.sell_price||0,"function"==typeof i.recalc&&i.recalc(window.globalQty||1,null),"function"==typeof window.safeRenderTable&&window.safeRenderTable())}})}window.comparativa.agregarItemPorId=async function(e){if(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window.ingredientObjs.some(t=>t.id==e))return;const t=document.getElementById("item-skeleton");try{"function"==typeof window.showSkeleton&&window.showSkeleton(t);const i=await m(e),n=await S(e);let r,a;if(n){let t=await b(e,n);Array.isArray(t)||(t=[]),r=await v(e),window._mainBuyPrice=r.buy_price||0,window._mainSellPrice=r.sell_price||0,window._mainRecipeOutputCount=n&&n.output_item_count||1,a=new o({id:i.id,name:i.name,icon:i.icon,rarity:i.rarity,count:1,buy_price:r.buy_price,sell_price:r.sell_price,is_craftable:!0,recipe:n,children:t}),a.recalc(window.globalQty||1,null)}else r=await v(e),window._mainBuyPrice=r.buy_price||0,window._mainSellPrice=r.sell_price||0,window._mainRecipeOutputCount=1,a=new o({id:i.id,name:i.name,icon:i.icon,rarity:i.rarity,count:1,buy_price:r.buy_price,sell_price:r.sell_price,is_craftable:!1,recipe:null,children:[]});window.ingredientObjs.push(a),j(),"function"==typeof window.safeRenderTable&&("number"==typeof r.buy_price&&"number"==typeof r.sell_price?window.safeRenderTable(r.buy_price,r.sell_price):window.safeRenderTable()),"function"==typeof window.hideSkeleton&&window.hideSkeleton(t)}catch(e){"function"==typeof window.hideSkeleton&&window.hideSkeleton(t),alert("Error al agregar el ítem: "+(e?.message||e)),console.error("Error al agregar el ítem",e)}},window.comparativa.handleSaveComparativa=async function(){if(!window.ingredientObjs||0===window.ingredientObjs.length)return void window.StorageUtils?.showToast("Agrega al menos un ítem a la comparativa","error");const e={ids:window.ingredientObjs.map(e=>e.id),nombres:window.ingredientObjs.map(e=>e.name),timestamp:Date.now()};window.StorageUtils&&"function"==typeof window.StorageUtils.saveComparativa?(await window.StorageUtils.saveComparativa(e),window.StorageUtils.showToast("Comparativa guardada")):alert("StorageUtils no está disponible.")},window.comparativa.loadComparativaFromURL=function(){const e=new URLSearchParams(window.location.search).get("ids");if(!e)return;const t=e.split(",").map(e=>parseInt(e,10)).filter(e=>!isNaN(e));if(0===t.length)return;window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1;const i=()=>{window.comparativa&&"function"==typeof window.comparativa.agregarItemPorId?(async()=>{for(const e of t)try{await window.comparativa.agregarItemPorId(e)}catch(t){console.error("Error cargando ítem de la URL",e,t)}})():setTimeout(i,50)};i()}}function E(e,t){return!e||!t||isNaN(e)||isNaN(t)||0===t?"-":(e/t*100).toFixed(1)+"%"}"undefined"!=typeof window&&(window.setIngredientObjs=r,window.setGlobalQty=a,window.snapshotExpandState=l,window.restoreExpandState=s,window.recalcAll=d,window.getTotals=c,window.findIngredientByIdAndParent=u,window.findIngredientByPath=w,window.findIngredientByUid=f,window.findIngredientById=p,window.calcPercent=E);export{o as C,l as a,s as b,_ as c,r as d,n as e,w as f,c as g,p as h,u as i,f as j,m as k,S as l,v as m,I as n,E as o,b as p,d as r,a as s};
