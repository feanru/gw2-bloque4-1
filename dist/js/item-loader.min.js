import{c as e,d as r,p as i,C as n,e as t,h as o}from"./items-core-CzQf1Qir.js";import{getItemBundles as a}from"./services/recipeService.min.js";import{update as l}from"./utils/stateManager.min.js";import"./utils/cache.min.js";import"./utils/cachePolicies.min.js";import"./utils/cacheSync.min.js";import"./utils/requestCache.min.js";let c=0,s=null,d=null;async function w(e){if(!Array.isArray(e)||0===e.length)return[];try{return await a(e)}catch(e){return console.error("Error cargando ítems",e),[]}}async function u(a){const w=++c;if(d&&(d.abort(),d=null),e(),!a)return void window.showError?.("ID de ítem no válido");let u=null,m=null;const p=document.getElementById("item-skeleton");try{window.showSkeleton?.(p),d=new AbortController;const e=await fetch(`/backend/api/itemDetails.php?itemId=${a}`,{signal:d.signal});if(!e.ok)throw new Error(`Error ${e.status} obteniendo detalles del ítem`);const h=e.headers.get("content-type")||"";if(!h.includes("application/json"))throw new Error(`Respuesta no válida: ${h}`);const{item:y,recipe:_,market:f}=await e.json();if(w!==c)return;if(window.hideSkeleton?.(p),m=f||{},window._mainBuyPrice=m.buy_price||0,window._mainSellPrice=m.sell_price||0,!_)return r([]),void window.initItemUI(y,m);window._mainRecipeOutputCount=_.output_item_count||1,setTimeout(async()=>{if(w!==c)return;let e;try{e=await i(a,_)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),r([]),void window.initItemUI(y,m)}Array.isArray(e)||(e=[]),u=new n({id:y.id,name:y.name,icon:y.icon,rarity:y.rarity,count:1,buy_price:m?.buy_price||0,sell_price:m?.sell_price||0,is_craftable:!0,recipe:_,children:e}),u.recalc(window.globalQty||1,null),r([u]),window.initItemUI(y,m);const d=new Set;!function e(r,i){i.add(r.id),r.children&&r.children.forEach(r=>e(r,i))}(u,d),s&&s.stop(),s=t(Array.from(d),{onUpdate:(e,r)=>{const i=o(window.ingredientObjs,e);i&&(i.buy_price=r.buy_price||0,i.sell_price=r.sell_price||0,i===window.ingredientObjs[0]&&(window._mainBuyPrice=i.buy_price,window._mainSellPrice=i.sell_price),i.recalc(window.globalQty||1,null),l(e,i))}})},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(p)}finally{d=null}}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),r=parseInt(e.get("id"),10);r?u(r):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{u as loadItem,w as loadItems};
